(()=>{void 0===tribe.tickets&&(tribe.tickets={}),"undefined"==typeof ajaxurl&&(ajaxurl=TribeTickets.ajaxurl),tribe.tickets.editor={};let e=window.ticketHeaderImage||{};!function(t,i,n,a){"use strict";const c=i(document),r=i(document.getElementById("tribetickets")),d=".recurrence-row",o=".recurrence-row.tribe-recurrence-not-supported",s=".tribe-event-recurrence-rule",l="#rsvp_form_toggle, #ticket_form_toggle, #settings_form_toggle",_=document.body.classList.contains("tec-no-tickets-on-recurring"),p=".tec_ticket-panel__helper_text__wrap",u=".tec_ticket-panel__recurring-unsupported-warning";let k=null,m=null;if(0===r.length)return;const f=i(document.getElementById("event_tickets")),b=i(document.getElementById("post_ID")),g=i(document.getElementById("publish")),y=r.find(".tribe-tickets-editor-blocker"),h=r.find(".spinner");let v=i(document.getElementById("tribe_panel_base")),w=i(document.getElementById("tribe_panel_edit")),I=i(document.getElementById("tribe_panel_settings"));const E=["yy-mm-dd","m/d/yy","mm/dd/yy","d/m/yy","dd/mm/yy","m-d-yy","mm-dd-yy","d-m-yy","dd-mm-yy","yy.mm.dd","mm.dd.yy","dd.mm.yy"];let x=E[0];function B(e){void 0===e&&(e=!0);let t,n=r.find(".tribe-ticket-editor-field-default_provider");n.is(":radio")&&(n=n.filter(":checked")),t=e?"Tribe__Tickets__RSVP":"TEC\\Tickets\\Commerce\\Module",!e&&n.length>0&&(t=n.val());const a=i(document.getElementById("tec_tickets_ticket_provider"));!e&&a.val()||a.val(t),m=a.val(),a.trigger("change")}a.beforeUnload=function(e){let t=!1;return"true"===v.attr("aria-hidden")&&(t=tribe_global_stock_admin_ui.nav_away_msg),e.returnValue=t,t},e={uploader(){const t=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return t.on("close",(function(){const i=t.state().get("selection").toJSON();i.length&&e.render(i[0])})),t.open(),!1},render(t){i(document.getElementById("tribe_ticket_header_preview")).html(e.imgHTML(t)),i(document.getElementById("tribe_ticket_header_image_id")).val(t.id),i(document.getElementById("tribe_ticket_header_remove")).show(),i(document.getElementById("tribe_tickets_image_preview_filename")).show().find(".filename").text(t.filename)},imgHTML(e){let t='<img src="'+e.url+'" ';return t+='width="'+e.width+'" ',t+='height="'+e.height+'" ',t+="/>",t}},a.panels={list:"#tribe_panel_base",ticket:"#tribe_panel_edit",settings:"#tribe_panel_settings"},a.swapPanel=function(e){let n;B("rsvp"===k),n=e instanceof jQuery?e:void 0!==a.panels[e]?i(a.panels[e]):v;const d=i("#event_tickets");d.trigger("before_panel_swap.tickets",{panel:n}),r.find(".ticket_panel").each((function(){i(this).attr("aria-hidden","true")})),n.attr("aria-hidden","false"),n.is(v)?(i(t).off("beforeunload.tribe"),c.trigger("tribe.dependencies-run")):i(t).on("beforeunload.tribe",a.beforeUnload),d.trigger("after_panel_swap.tickets",{panel:n})},a.fetchPanels=function(e,t,n){n=n||"default",null==e?e={ticket_type:n}:e+="&ticket_type="+n;const c={action:"tribe-ticket-panels",notice:!1,post_id:b.val(),nonce:TribeTickets.add_ticket_nonce,data:e,is_admin:i("body").hasClass("wp-admin")};i.post(ajaxurl,c,(function(e){e.success&&a.refreshPanels(e.data,t)}),"json")},a.startWatchingMoveLinkIn=function(){f.find(".tribe-ticket-move-link").one("click",(function(){t.setTimeout(a.listentToThickboxEvents,250)}))},a.listentToThickboxEvents=function(){const e=i("#TB_window");0!==e.length&&e.one("tb_unload",(function(){a.fetchPanels(null,"list")}))},a.refreshPanels=function(e,t){v=i(e.list),w=i(e.ticket),I=i(e.settings),r.find(a.panels.list).replaceWith(v),r.find(a.panels.ticket).replaceWith(w),r.find(a.panels.settings).replaceWith(I),a.setupPanels(),a.swapPanel(t),i(".tribe-dependency").trigger("verify.dependency")},a.setupPanels=function(){t.MTAccordion({target:".accordion"});const e=i(document.getElementById("tribe-event-datepickers")),n=i(document.getElementById("ticket_start_date")),a=i(document.getElementById("ticket_end_date"));i(document.getElementById("ticket_start_time")),i(document.getElementById("ticket_end_time"));let c=0;document.getElementById("ticket_name_label");const d=i(document.getElementById("ticket_sale_start_date")),o=i(document.getElementById("ticket_sale_end_date"));if("undefined"==typeof tribe_datepicker_opts){const e=i("[data-datepicker_format]"),n=e.length?e.attr("data-datepicker_format"):"",a=parseInt(n,10);isNaN(a)||(t.tribe_datepicker_opts={dateFormat:E[a]})}const s=t.tribe_datepicker_opts||{};if(e.length&&e.data("startofweek"),"undefined"!=typeof tribe_ticket_datepicker_format){const e=(l=tribe_ticket_datepicker_format.datepicker_format_index,!isNaN(parseFloat(l))&&isFinite(l)?tribe_ticket_datepicker_format.datepicker_format_index:0);x=E[e]}else s&&s.dateFormat&&(x=s.dateFormat);var l;const _={dateFormat:x,showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,showButtonPanel:!1,onChange(){},beforeShow(e,t){t.input.data("prevDate",t.input.datepicker("getDate"));const n=i(t.dpDiv);n.addClass("tribe-ui-datepicker"),n.attrchange({trackValues:!0,callback(e){(e.newValue.indexOf("display: none")>=0||e.newValue.indexOf("display:none")>=0)&&n.removeClass("tribe-ui-datepicker")}})},onSelect(e,t){const c=i.datepicker.parseDate(x,e);switch(t.id){case"ticket_start_date":a.datepicker("option","minDate",c);break;case"ticket_end_date":n.datepicker("option","maxDate",c);break;case"ticket_sale_start_date":o.datepicker("option","minDate",c);break;case"ticket_sale_end_date":d.datepicker("option","maxDate",c)}}};i.extend(_,tribe_l10n_datatables.datepicker);const p=r.find(".tribe-timepicker:not(.ui-timepicker-input)");if(tribe_timepickers.setup_timepickers(p),n.datepicker(_).datepicker("option","defaultDate",i(document.getElementById("EventStartDate")).val()).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||i.datepicker._clearDate(this)})),a.datepicker(_).datepicker("option","defaultDate",i(document.getElementById("EventEndDate")).val()).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||i.datepicker._clearDate(this)})),d.datepicker(_).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||i.datepicker._clearDate(this)})),o.datepicker(_).on("keyup",(function(e){8!==e.keyCode&&46!==e.keyCode||i.datepicker._clearDate(this)})),i(document.getElementById("tribe_ticket_header_preview")).find("img").length){i(document.getElementById("tribe_ticket_header_remove")).show();const e=i(document.getElementById("tribe_ticket_header_preview")).find("img");e.removeAttr("width").removeAttr("height"),r.width()<e.width()&&e.css("width","95%")}"undefined"!=typeof tribe_event_tickets_plus&&i.isPlainObject(tribe_event_tickets_plus)&&i.isPlainObject(tribe_event_tickets_plus.meta)&&i.isPlainObject(tribe_event_tickets_plus.meta.admin)&&"function"==typeof tribe_event_tickets_plus.meta.admin.init_ticket_fields&&tribe_event_tickets_plus.meta.admin.init_ticket_fields(),tribe.tickets.table&&0!==v.find(".tribe-tickets-editor-table-tickets-body tr").length&&tribe.tickets.table.toggle_sortable(),r.find(tribe.validation.selectors.item).validation(),r.find(".tribe-dependent").dependency(),r.find(".tribe-dependency").trigger("verify.dependency")},c.ajaxSend((function(e,t,n){"string"===i.type(n.data)&&-1!==n.data.indexOf("action=tribe-ticket")&&r.trigger("spin.tribe","start")})),c.ajaxComplete((function(e,t,n){"string"===i.type(n.data)&&-1!==n.data.indexOf("action=tribe-ticket")&&r.trigger("spin.tribe","stop")})),c.on({"spin.tribe"(e,t){(void 0===t||i.inArray(t,["start","stop"]))&&(t="stop"),"stop"===t?(y.hide(),h.removeClass("is-active")):(y.show(),h.addClass("is-active"))}}),g.on("click",(function(e){i(t).off("beforeunload.tribe")})),c.on("click","#settings_form_toggle",(function(e){return e.preventDefault(),a.fetchPanels(null,"settings"),!1})),c.on("click","#capacity_form_toggle",(function(e){return e.preventDefault(),a.fetchPanels(null,"settings"),!1})),c.on("click","#tribe_settings_form_cancel, #ticket_form_cancel",(function(e){return e.preventDefault(),a.fetchPanels(null,"list"),!1})),c.on("click","#tribe_settings_form_save",(function(e){e.preventDefault();const t=I.find("input,textarea").serialize();return a.fetchPanels(t,"list"),!1})),c.on("click",".ticket_form_toggle",(function(e){e.preventDefault();const t=i(this),n="rsvp_form_toggle"===t.attr("id");return k=n?"rsvp":t.data("ticket-type"),B(n),w.find(".tribe-dependency").trigger("verify.dependency"),a.fetchPanels(null,"ticket",k),!1})),c.on("click",".ticket_edit_button",(function(e){e.preventDefault();const t=i(this);k=t.closest("[data-ticket-type]").data("ticket-type");const n={action:"tribe-ticket-edit",post_id:b.val(),ticket_id:t.data("ticketId"),nonce:TribeTickets.edit_ticket_nonce,is_admin:i("body").hasClass("wp-admin")};return i.post(ajaxurl,n,(function(t){t.success&&(a.refreshPanels(t.data,"ticket"),a.startWatchingMoveLinkIn("#event_tickets"),r.trigger("edit-ticket.tribe",e))}),"json"),!1})),c.on("click.tribe",'[name="ticket_form_save"]',(function(e){const t=i(document.getElementById("ticket_form_table"));let n=!0;if(t.trigger("validation.tribe"),tribe.validation.hasErrors(t))return;if(n=r.triggerHandler("additionalValidation.tribe",[n]),!1===n)return;r.trigger("pre-save-ticket.tribe",e);const c=w.find("#ticket_id").val(),d=v.find(`[data-ticket-type-id="${c}"]`).find(".tribe-ticket-field-order").val();let o=w.find("input,textarea,select").serialize().replace(/\'/g,"%27").replace(/\:/g,"%3A");o.includes("ticket_provider")||(o+="&ticket_provider="+encodeURIComponent(m));const s={action:"tribe-ticket-add",data:o,post_id:b.val(),nonce:TribeTickets.add_ticket_nonce,menu_order:d,is_admin:i("body").hasClass("wp-admin"),ticket_type:k};s.data=s.data.concat("&ticket_menu_order="+d),i.post(ajaxurl,s,(function(e){e.success&&a.refreshPanels(e.data)}),"json")})),c.on("click",".ticket_delete",(function(e){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;e.preventDefault(),r.trigger("delete-ticket.tribe",e);const t=i(this).attr("attr-ticket-id"),n={action:"tribe-ticket-delete",post_id:b.val(),ticket_id:t,nonce:TribeTickets.remove_ticket_nonce,is_admin:i("body").hasClass("wp-admin")};i.post(ajaxurl,n,(function(e){e.success&&a.refreshPanels(e.data)}),"json")})),c.on("click",".ticket_duplicate",(function(e){e.preventDefault();const t=i(this),n={action:"tribe-ticket-duplicate",post_id:b.val(),ticket_id:t.data("ticketId"),nonce:TribeTickets.duplicate_ticket_nonce,is_admin:i("body").hasClass("wp-admin")};return i.post(ajaxurl,n,(function(e){e.success&&a.refreshPanels(e.data)}),"json"),!1})),c.on("change",".tribe-ticket-field-capacity",(function(e){const t=i(this),n=t.parents(".input_block").eq(0).find(".tribe-ticket-field-mode");t.val()&&n.val("capped")})),c.on("keyup","#ticket_price, #ticket_sale_price",(function(e){e.preventDefault();const t=price_format.decimal,n=new RegExp("[^-0-9%\\"+t+"]+","gi"),a=i(this).val(),c=a.replace(n,"");a!==c&&i(this).val(c)})),c.on("click","#tribe_ticket_header_image, #tribe_ticket_header_preview",(function(t){t.preventDefault(),e.uploader("","")})),c.on("focus","#settings_global_capacity_edit",(function(){const e=i(this);let t=0;i(".tribe-tickets-editor-capacity-table").find("[data-capacity]").each((function(){const e=i(this);t+=parseInt(e.data("capacity"),10)})),e.data("nonSharedCapacity",t)})),c.on("blur change","#settings_global_capacity_edit",(function(){const e=i(".tribe-tickets-editor-table-row-capacity-total");if(-1===parseInt(e.data("totalCapacity"),10))return;const t=i(this),a=e.find(".tribe-tickets-editor-total-capacity");let c=parseInt(t.val(),10);const r=t.data("nonSharedCapacity");(""===c||0>c||n.isNaN(c))&&(c=0);const d=r+c;a.text(d)})),c.on("click","#global_capacity_edit_button",(function(e){e.preventDefault(),i(document.getElementById("settings_global_capacity_edit")).prop("disabled",!1).focus()})),c.on("blur",'[name="tribe-ticket[event_capacity]"]',(function(e,t){if(void 0===t&&(t=i(this).val()),void 0===t)return;t||(t=0),t=parseInt(t,10);const n=i(".tribe-ticket-capacity-max").find(".tribe-ticket-capacity-value"),a=i('.tribe-ticket-field-capacity[name="tribe-ticket[capacity]"]');a.attr("placeholder",t),t?a.attr("max",t):t=0,n.text(t)})),c.on("change",'[name="tribe-ticket[capacity]"]',(function(e){const t=i(this),n=parseInt(t.attr("max"),10),a=parseInt(t.val(),10);n&&n<a&&t.val(n)})),_?(c.on("tribe-recurrence-active",(function(e){i(l).hide(),i(p).hide(),i(u).show()})),c.on("tribe-recurrence-inactive",(function(e){i(l).show(),i(p).show(),i(u).hide()})),c.on("tribe-tickets-active",(function(e){i(d).hide(),i(o).css("visibility","visible").show()})),c.on("tribe-tickets-inactive",(function(e){i(s).find(".tribe-recurrence-rule").length>0?i(d).show():i(".recurrence-row.tribe-datetime-block:not(.tribe-recurrence-exclusion-row)").show(),i(o).hide()}))):i(l).parent().find(".ticket-editor-notice.recurring_event_warning").hide(),c.on("click","#tribe_ticket_header_remove",(function(e){e.preventDefault(),i(document.getElementById("tribe_ticket_header_preview")).html(""),i(document.getElementById("tribe_ticket_header_remove")).hide(),i(document.getElementById("tribe_tickets_image_preview_filename")).hide().find(".filename").text(""),i(document.getElementById("tribe_ticket_header_image_id")).val("")})),c.on("after_panel_swap.tickets",(function(){c.trigger("tribe-tickets-active")})),c.on("verify.dependency",(function(){i(".tribe-tickets-editor-table-tickets-body").is(":visible")?c.trigger("tribe-tickets-active"):c.trigger("tribe-tickets-inactive"),i(s).is(":visible")?c.trigger("tribe-recurrence-active"):c.trigger("tribe-recurrence-inactive")})),i(a.setupPanels)}(window,jQuery,_,tribe.tickets.editor),window.tec=window.tec||{},window.tec.tickets=window.tec.tickets||{},window.tec.tickets.tickets={}})();